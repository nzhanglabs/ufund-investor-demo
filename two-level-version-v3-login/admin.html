<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UFUND Admin Console (Demo)</title>
    <style>
      body { margin: 0; font-family: "Source Sans 3", "Segoe UI", sans-serif; background: #f3f6fb; color: #17304d; }
      .wrap { max-width: 900px; margin: 26px auto; background: #fff; border: 1px solid #d9e3ef; border-radius: 12px; box-shadow: 0 12px 26px rgba(15, 39, 68, 0.08); padding: 18px; }
      h1 { margin: 0 0 8px; font-size: 30px; font-family: "Montserrat", sans-serif; }
      .sub { margin: 0 0 14px; color: #5f7390; }
      .card { border: 1px solid #e3ebf5; border-radius: 10px; padding: 12px; margin-bottom: 12px; background: #f9fcff; }
      .row { display: grid; grid-template-columns: 1fr 1fr auto; gap: 8px; }
      .field { display: grid; gap: 6px; margin-bottom: 8px; }
      label { font-size: 13px; font-weight: 700; }
      input, select { border: 1px solid #d6e1ee; border-radius: 8px; padding: 9px; font: inherit; }
      .btn { border: 0; border-radius: 8px; background: #f59a23; color: #fff; font-weight: 700; padding: 9px 12px; cursor: pointer; }
      .btn.secondary { background: #eef3f9; color: #244266; }
      table { width: 100%; border-collapse: collapse; }
      th, td { border-bottom: 1px solid #e1e9f3; padding: 8px; text-align: left; font-size: 14px; }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 12px; word-break: break-all; }
      .error { color: #b5391f; font-size: 13px; min-height: 18px; }
      .ok { color: #2f6b45; font-size: 13px; min-height: 18px; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>Admin Console (Demo)</h1>
      <p class="sub">Invite investors to register and upgrade access from Qualified Access(Limited) to Club Member.</p>

      <div id="authCard" class="card">
        <div class="field">
          <label>Admin Passcode</label>
          <input id="adminPass" type="password" placeholder="Enter admin passcode" />
        </div>
        <button id="unlockBtn" class="btn" type="button">Unlock</button>
        <div id="authError" class="error"></div>
      </div>

      <div id="panel" style="display:none;">
        <div class="card">
          <h3 style="margin-top:0;">Create Invite Link</h3>
          <div class="row">
            <input id="inviteEmail" type="email" placeholder="Investor email" />
            <select id="inviteRole">
              <option value="qualified">Qualified Access(Limited)</option>
              <option value="member">Club Member</option>
            </select>
            <button id="createInviteBtn" class="btn" type="button">Create Link</button>
          </div>
          <div id="inviteResult" class="mono" style="margin-top:8px;"></div>
        </div>

        <div class="card">
          <h3 style="margin-top:0;">Manage Users (Upgrade Access)</h3>
          <table>
            <thead>
              <tr><th>Email</th><th>Name</th><th>Role</th><th>Action</th></tr>
            </thead>
            <tbody id="userRows"></tbody>
          </table>
          <div id="saveMsg" class="ok"></div>
        </div>
      </div>
    </div>

    <script>
      const ADMIN_PASSCODE = "ufund-admin-demo";
      const AUTH_KEYS = {
        users: "ufund_auth_users",
        invites: "ufund_auth_invites",
        session: "ufund_auth_session"
      };

      const DEFAULT_INVITES = [
        { token: "UFUND-QUALIFIED-DEMO", email: "qualified.demo@ufundinvestment.com", initialRole: "qualified", used: false },
        { token: "UFUND-MEMBER-DEMO", email: "member.demo@ufundinvestment.com", initialRole: "member", used: false }
      ];

      const readJSON = (k, f) => { try { const raw = localStorage.getItem(k); return raw ? JSON.parse(raw) : f; } catch { return f; } };
      const writeJSON = (k, v) => localStorage.setItem(k, JSON.stringify(v));
      const invites = readJSON(AUTH_KEYS.invites, []);
      if (!invites.length) writeJSON(AUTH_KEYS.invites, DEFAULT_INVITES);

      function renderUsers() {
        const users = readJSON(AUTH_KEYS.users, []);
        const tbody = document.getElementById("userRows");
        tbody.innerHTML = users.map((u, idx) => `
          <tr>
            <td>${u.email || ""}</td>
            <td>${(u.firstName || "") + " " + (u.lastName || "")}</td>
            <td>
              <select data-idx="${idx}" class="roleSel">
                <option value="qualified" ${u.role === "qualified" ? "selected" : ""}>Qualified Access(Limited)</option>
                <option value="member" ${u.role === "member" ? "selected" : ""}>Club Member</option>
              </select>
            </td>
            <td><button class="btn secondary saveRoleBtn" data-idx="${idx}" type="button">Save</button></td>
          </tr>
        `).join("");

        document.querySelectorAll(".saveRoleBtn").forEach((btn) => {
          btn.addEventListener("click", () => {
            const i = Number(btn.dataset.idx);
            const sel = document.querySelector(`.roleSel[data-idx=\"${i}\"]`);
            const usersNow = readJSON(AUTH_KEYS.users, []);
            usersNow[i].role = sel.value;
            writeJSON(AUTH_KEYS.users, usersNow);

            const session = readJSON(AUTH_KEYS.session, null);
            if (session?.email && session.email.toLowerCase() === (usersNow[i].email || "").toLowerCase()) {
              writeJSON(AUTH_KEYS.session, { ...session, role: sel.value });
            }

            document.getElementById("saveMsg").textContent = "User role updated.";
            setTimeout(() => { document.getElementById("saveMsg").textContent = ""; }, 1200);
          });
        });
      }

      document.getElementById("unlockBtn").addEventListener("click", () => {
        const pass = document.getElementById("adminPass").value;
        if (pass !== ADMIN_PASSCODE) {
          document.getElementById("authError").textContent = "Invalid admin passcode.";
          return;
        }
        document.getElementById("authCard").style.display = "none";
        document.getElementById("panel").style.display = "block";
        renderUsers();
      });

      document.getElementById("createInviteBtn").addEventListener("click", () => {
        const email = document.getElementById("inviteEmail").value.trim().toLowerCase();
        const initialRole = document.getElementById("inviteRole").value;
        if (!email) return;

        const token = `UFUND-${initialRole.toUpperCase()}-${Math.random().toString(36).slice(2, 8).toUpperCase()}`;
        const invitesNow = readJSON(AUTH_KEYS.invites, []);
        invitesNow.push({ token, email, initialRole, used: false, createdAt: new Date().toISOString() });
        writeJSON(AUTH_KEYS.invites, invitesNow);

        const basePath = window.location.pathname.replace(/\/[^/]*$/, "/");
        const link = `${window.location.origin}${basePath}register.html?token=${encodeURIComponent(token)}`;
        document.getElementById("inviteResult").textContent = link;
      });
    </script>
  </body>
</html>
